{% extends 'blogInfo/base.html' %}

{% block content %}
    
    <article class="post-card" style="border-bottom: none;">
        
        <h1 class="post-title" style="font-size: 3rem; text-align: center; margin-bottom: 10px;">{{ post.titulo }}</h1>
        
        {% if post.subtitulo %}
            <h3 style="text-align: center; font-style: italic; color: var(--ink-secondary); margin-bottom: 30px;">
                {{ post.subtitulo }}
            </h3>
        {% endif %}

        <div class="post-meta" style="text-align: center; margin-bottom: 40px; border-bottom: 1px solid var(--accent-lines); padding-bottom: 20px;">
            Por <strong>{{ post.autor_post.nombre }}</strong> | {{ post.fecha_publicacion|date:"d F Y" }}
            | Categor√≠as: 
            {% for cat in post.categorias.all %}
                <a href="{% url 'categoria_posts' cat.id %}" style="color: var(--ink-primary); font-weight: bold; text-decoration: none;">
                    {{ cat.nombre }}
                </a>{% if not forloop.last %}, {% endif %}
            {% endfor %}
        </div>

        {% if post.imagen %}
            <img src="{{ post.imagen.url }}" class="post-image" style="height: auto; max-height: 600px;" alt="{{ post.titulo }}">
        {% endif %}

        <div class="post-content" style="font-size: 1.2rem; text-align: justify;">
            {{ post.contenido|linebreaks }}
        </div>

        <div style="margin-top: 50px; text-align: center;">
            <a href="{% url 'home' %}" class="btn-read" style="font-size: 0.9rem;">&larr; Volver al pagina principal</a>
        </div>

    </article>


    <section style="max-width: 800px; margin: 0 auto 60px auto; padding-top: 40px; border-top: 4px double var(--ink-secondary);">
        
        <h3 class="main-title" style="font-size: 1.8rem; margin-top: 0; border-bottom: none;">Comentarios de los usuarios</h3>

        {% if user.is_authenticated %}
            <div style="background-color: rgba(0,0,0,0.05); padding: 20px; border-radius: 4px; margin-bottom: 40px;">
                <h4 style="margin-top: 0; font-family: var(--font-heading);">Deja tu opini√≥n, {{ user.username }}:</h4>
                <form method="post">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit" class="btn-read" style="font-size: 0.8rem; cursor: pointer; border: none; margin-top: 10px;">
                        Publicar Comentario
                    </button>
                </form>
            </div>
        {% else %}
            <div style="text-align: center; margin-bottom: 40px; padding: 20px; border: 1px dashed var(--ink-muted);">
                <p style="font-style: italic;">Debes ser miembro para opinar.</p>
                <a href="{% url 'login' %}" class="btn-read" style="font-size: 0.8rem;">Iniciar Sesi√≥n</a>
            </div>
        {% endif %}

        <div class="comments-list">
    {% for comentario in comentarios %}
        
        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--accent-lines); background-color: rgba(255,255,255,0.4);">
            
            <div style="font-family: var(--font-heading); font-weight: bold; font-size: 0.9rem; color: var(--ink-primary); margin-bottom: 5px;">
                {{ comentario.usuario.username }} 
                <span style="font-weight: normal; color: var(--ink-muted); font-size: 0.8rem;">
                    - {{ comentario.fecha_creacion|date:"d M, H:i" }}
                </span>
            </div>
            
            <p style="margin: 5px 0 10px 0; font-size: 1rem; color: var(--ink-secondary);">
                {{ comentario.contenido_comentario }}
            </p>

            <div style="font-size: 0.8rem; border-top: 1px dotted var(--accent-lines); padding-top: 5px;">
                {% if user.is_authenticated %}
                    <a href="{% url 'responder_comentario' comentario.pk %}" style="color: var(--ink-primary); font-weight: bold; margin-right: 15px; text-decoration: none;">
                        üí¨ Responder
                    </a>
                {% endif %}

                {% if user.is_authenticated and comentario.usuario == request.user or user.is_staff %}
                    <a href="{% url 'editar_comentario' comentario.pk %}" style="color: var(--ink-muted); text-decoration: none; margin-right: 10px;">[Editar]</a>
                    <a href="{% url 'borrar_comentario' comentario.pk %}" onclick="return confirm('¬øBorrar?');" style="color: #b94a48; text-decoration: none;">[Borrar]</a>
                {% endif %}
            </div>

        </div>

        {% for respuesta in comentario.respuestas.all %}
            <div style="margin-left: 50px; margin-bottom: 15px; padding: 10px; border-left: 3px solid var(--ink-muted); background-color: rgba(0,0,0,0.03);">
                
                <div style="font-size: 0.85rem; font-weight: bold; color: var(--ink-secondary);">
                    {{ respuesta.usuario.username }} 
                    <span style="font-weight: normal; color: var(--ink-muted);">respondi√≥:</span>
                </div>

                <p style="margin: 5px 0; font-size: 0.95rem;">
                    {{ respuesta.contenido_comentario }}
                </p>

                {% if user.is_authenticated and respuesta.usuario == request.user or user.is_staff %}
                    <div style="font-size: 0.75rem; margin-top: 5px;">
                        <a href="{% url 'editar_comentario' respuesta.pk %}" style="color: var(--ink-muted);">[Editar]</a>
                        <a href="{% url 'borrar_comentario' respuesta.pk %}" onclick="return confirm('¬øBorrar?');" style="color: #b94a48; margin-left: 5px;">[Borrar]</a>
                    </div>
                {% endif %}
            </div>
        {% endfor %}

    {% empty %}
        <p style="text-align: center; font-style: italic; color: var(--ink-muted);">
            S√© el primero en comentar üç∫.
        </p>
    {% endfor %}
</div>

    </section>

{% endblock %}